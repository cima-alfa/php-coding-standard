#!/usr/bin/env php
<?php

declare(strict_types=1);

use CimaAlfaCSFixers\Helpers;
use CimaAlfaCSFixers\Message\Error;

if (
	!(is_file($file = ($vendorDir = __DIR__ . '/../vendor') . '/autoload.php') && include $file) &&
	!(is_file($file = ($vendorDir = __DIR__ . '/../../..') . '/autoload.php') && include $file)
) {
    require_once __DIR__ . '/../src/Message/Error.php';
    require_once __DIR__ . '/../src/Helpers.php';

	Helpers::error(Error::InstallPackages);
}

$rootDir = getcwd();

while (!is_file("$rootDir/composer.json") && substr_count($rootDir, DIRECTORY_SEPARATOR) > 1) {
	$rootDir = dirname($rootDir);
}

if (!is_file("$rootDir/composer.json")) {
	$rootDir = getcwd();

	Helpers::warning("Could not find \e[file]composer.json\e[reset], using current directory '\e[file]$rootDir\e[reset]' as project root.");
}

$fixerBin = $vendorDir . '/friendsofphp/php-cs-fixer/php-cs-fixer';
$configExec = Helpers::normalizePath(__DIR__ . '/../cs/config.php');

if (!is_file($configExec)) {
    Helpers::error(Error::FixerConfigFileMissing->internal($configExec));
}

$noColor = Helpers::getNoColor() ? 'NO_COLOR=1' : '';
$forceColor = Helpers::getForceColor() || Helpers::detectColors() ? 'FORCE_COLOR=1' : '';

// /** @var Config $config */
// $config = require_once __DIR__ . '/../cs/config.php';

// new CheckCommand(new ToolInfo)->r
$cmd = 'CIMA_ALFA_PHP_CODING_STANDARD_ROOT=' . escapeshellarg($rootDir)
    . " $noColor $forceColor PHP_CS_FIXER_ALLOW_XDEBUG=1 "
    . PHP_BINARY . ' ' . escapeshellarg($fixerBin)
    . ' check -v'
    . ' --config=' . escapeshellarg($configExec);

@passthru(
    $cmd,
    $exitCode,
);

// // if ($exitCode !== 0) {
// //     Helpers::error("Execution failed. Exit code: $exitCode");
// // }
// // echo $exitCode;
// echo($output);
