#!/usr/bin/env php
<?php

declare(strict_types=1);

use CimaAlfaCSFixers\Helpers;

if (
	!(is_file($file = ($vendorDir = __DIR__ . '/../vendor') . '/autoload.php') && include $file) &&
	!(is_file($file = ($vendorDir = __DIR__ . '/../../..') . '/autoload.php') && include $file)
) {
	Helpers::error('Install packages using Composer.');
}

$rootDir = getcwd();

while (!is_file("$rootDir/composer.json") && substr_count($rootDir, DIRECTORY_SEPARATOR) > 1) {
	$rootDir = dirname($rootDir);
}

if (!is_file("$rootDir/composer.json")) {
	$rootDir = getcwd();

	Helpers::warning("Could not find composer.json, using current directory '$rootDir' as project root.");
}



$fixerBin = $vendorDir . '/friendsofphp/php-cs-fixer/php-cs-fixer';
$configExec = __DIR__ . '/../src/cs/config.php';
$cmd = 'CIMA_ALFA_PHP_CODING_STANDARD_ROOT=' . escapeshellarg($rootDir) . ' '
    . PHP_BINARY . ' ' . escapeshellarg($fixerBin)
    . ' check -v'
    . ' --config=' . escapeshellarg($configExec);

ob_start();

@passthru(
    $cmd,
    $exitCode,
);

$output = ob_get_clean();

// if ($exitCode !== 0) {
//     Helpers::error("Execution failed. Exit code: $exitCode");
// }
echo $exitCode;
echo($output);
